{% load static %}

<style type="text/css">
{% block map_css %}
  #{{ widget.attrs.map_id }} {
    max-width: 800px;
    height: 400px;
  }
{% endblock map_css %}
</style>

<div id="{{ widget.attrs.map_id }}"></div>

{% include widget.attrs.field_template_name with widget=widget %}

<script>
django.jQuery(document).ready(function() {
  var map = L.map({{ widget.attrs.map_id }});
  var center;
  var field = document.getElementById('{{ widget.attrs.id }}');

  function readData() {
    var data = JSON.parse(field.value);
    return {
      lat: data.map_lat,
      lng: data.map_lng,
      zoom: data.map_zoom,
    };
  }

  function updateData(data) {
    if (data.lat === undefined || data.lng === undefined || data.zoom === undefined) {
      data = map.getCenter();
      data.zoom = map.getZoom();
    } else {
      map.setView([data.lat, data.lng], data.zoom);
    }
    field.value = JSON.stringify({
      map_lat: data.lat,
      map_lng: data.lng,
      map_zoom: data.zoom,
    });
    if (center) map.removeLayer(center);
    center = L.marker([data.lat, data.lng]).addTo(map);
  }

  var originalData = readData();
  updateData(readData());

  var GEOPORTAL_API_KEY = 'choisirgeoportail';
  var geoportalLayers = [
    {
      name: 'ORTHOIMAGERY.ORTHOPHOTOS',
      style: 'normal',
      format: 'image/jpeg',
    },
  ];

  for (var layer of geoportalLayers) {
    L.tileLayer(
      "https://wxs.ign.fr/{apiKey}/geoportail/wmts?" +
      "REQUEST=GetTile&" +
      "SERVICE=WMTS&" +
      "VERSION=1.0.0&" +
      "TILEMATRIXSET=PM&" +
      "LAYER={name}&" +
      "STYLE={style}&" +
      "FORMAT={format}&" +
      "TILECOL={x}&" +
      "TILEROW={y}&" +
      "TILEMATRIX={z}",
      {

        apiKey: GEOPORTAL_API_KEY,
        maxZoom: 19,
        attribution: '<a href="https://www.geoportail.gouv.fr/">geoportail.gouv.fr</a>',
        name: layer.name,
        style: layer.style,
        format: layer.format,
      }
    ).addTo(map);
  }

  map.on('move', updateData);
  map.on('zoomend', updateData);

  var resetControl = L.Control.extend({
    options: {
      position: 'topleft'
    },
    onAdd: function(map) {
      var container = L.DomUtil.create(
        'div',
        'leaflet-bar leaflet-control leaflet-control-custom'
      );
      container.style.background = 'url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAA4ElEQVQYGQXBsUpCAQAF0PN6L02isjJcg6AhqKXNhoYamxr6HOlrWloigkBEknBxCBxrcApRxLEhGm7nAHDuQUT0XSsAgIaRiIiImGoBUDcXny7UFWrOjMWvfYAn8agEUHkX8aWAQzFTAagMxcyHuISuuAVQGYq5LafiFSaiBSi9ibltrIso+BENUBqIhR1ARMVEtFHqi6UmoBJRcC/ulHpiqQngRPThSKz0xMouAIbiCngRsbIHgK6YKoANCzHVUUPp2ED8OQBg01hERER8awMAdDyLiJEbawAAQKFSAAD/Jphh2xjysk4AAAAASUVORK5CYII=) white no-repeat center';
      container.style.border = '1px solid #000';
      container.style.width = '30px';
      container.style.height = '30px';
      container.style.cursor = 'pointer';
      container.title = 'Revenir au d√©part';

      container.onclick = function() {
        updateData(originalData);
      }

      return container;
    },
  });
  map.addControl(new resetControl());
});
</script>
